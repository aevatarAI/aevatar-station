# DLL页修改功能 PRD

## 1. 功能概述

### 1.1 功能背景
DLL页面需要进行功能扩展，增加配置管理能力，同时保持原有功能的稳定性。

### 1.2 功能目标
- 保留现有DLL功能的完整性
- 新增Cross-URL管理功能
- 提供配置重启应用机制
- 优化项目创建流程中的Domain Name限制

### 1.3 功能优先级
- **P0（核心功能）**: DLL原有逻辑保持、Cross-URL基础功能
- **P1（重要功能）**: 全局重启按钮、Domain Name限制
- **P2（优化功能）**: 用户体验优化、错误处理完善

## 2. 详细需求规格

### 2.1 DLL部分

#### 2.1.1 功能要求
- **兼容性保证**: 保留原有逻辑，确保最后一列状态显示功能正常
- **界面保持**: 现有DLL列表的展示方式和交互保持不变
- **数据完整**: 所有原有的DLL数据和状态信息需完整保留

#### 2.1.2 技术要求
- 不影响现有API接口
- 数据库结构向后兼容
- 现有业务逻辑不受影响

### 2.2 Cross-URL功能

#### 2.2.1 数据模型

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| URL | String | 是 | 目标域名/URL地址 |
| Created | DateTime | 是 | 创建时间（系统自动生成） |
| Created by | String | 是 | 创建人（当前登录用户） |
| ID | String | 是 | 唯一标识符（系统自动生成） |

#### 2.2.2 界面设计要求

**列表展示**
- 表格形式展示所有Cross-URL记录
- 列标题：URL、Created、Created by
- 支持按创建时间排序（最新在顶部）
- 每行末尾提供删除操作按钮

**添加功能**
- 提供"Add"按钮，位置在列表上方
- 点击后弹出模态框
- 模态框标题："Add Cross-URL"
- 输入字段：URL（必填，带格式校验）

#### 2.2.3 交互流程设计

**添加流程**
```
用户点击"Add"按钮
↓
弹出添加模态框
↓
用户输入URL
↓
点击"添加"按钮
↓
系统校验URL格式
↓
校验通过：保存数据 + 关闭弹窗 + 刷新列表 + 显示成功Toast
校验失败：显示错误提示，保持弹窗打开
```

**删除流程**
```
用户点击某行的删除按钮
↓
弹出确认对话框："确定要删除这个Cross-URL吗？"
↓
用户确认：执行删除 + 刷新列表 + 显示成功Toast
用户取消：关闭确认框，无操作
```

#### 2.2.4 数据校验规则

**URL格式校验**
- 必须为合法的域名或URL格式
- 支持格式：
  - `example.com`
  - `https://example.com`
  - `http://subdomain.example.com:8080`
- 不允许空格和特殊字符
- 长度限制：最大255字符

### 2.3 全局按钮功能

#### 2.3.1 按钮设计
- **按钮文案**: "Restart to apply config"
- **按钮位置**: 页面右上角或功能区明显位置
- **按钮样式**: 主要操作按钮样式（Primary Button）

#### 2.3.2 交互流程
```
用户点击"Restart to apply config"按钮
↓
立即显示Toast提示："Service is restarting"（不自动消失）
↓
后台执行以下步骤：
  1. 读取当前所有Cross-URLs数据
  2. 将URLs写入deployment template配置文件
  3. 应用新的deployment配置到K8s集群
  4. 触发Pod重启操作
↓
系统监控重启状态和配置应用状态
↓
重启成功且配置生效：更新Toast为"Service restarted successfully"（3秒后自动消失）
重启失败或配置异常：更新Toast为"Service restart failed, please try again"（不自动消失）
```

#### 2.3.3 状态管理
- 重启期间按钮置为不可点击状态
- 显示loading状态指示器
- 重启完成后恢复按钮可用状态

### 2.4 创建项目调整

#### 2.4.1 Project Settings页面调整
- **Domain Name字段**: 设置为只读状态
- **视觉标识**: 灰色背景或禁用样式
- **说明文案**: 字段下方添加说明"Domain name cannot be modified"

#### 2.4.2 创建Project弹窗调整
- **Domain Name输入框**: 保持可编辑状态
- **辅助文案**: 输入框下方添加警告文案
  - 文案内容："Domain name can't be changed once set."
  - 样式：橙色或警告色，小字号
  - 位置：紧贴Domain Name输入框下方

## 3. 技术实现要点

### 3.1 后端接口设计

#### Cross-URL管理接口
```
GET /api/cross-urls - 获取Cross-URL列表
POST /api/cross-urls - 创建Cross-URL
DELETE /api/cross-urls/{id} - 删除Cross-URL
```

#### 重启配置接口
```
POST /api/system/restart - 触发服务重启（包含配置更新）
GET /api/system/status - 获取系统状态
POST /api/system/update-deployment - 更新deployment template
GET /api/system/deployment-status - 获取deployment配置状态
```

### 3.2 前端技术要求
- 使用统一的UI组件库
- 实现响应式设计
- 支持国际化（如需要）
- 遵循无障碍设计标准

### 3.3 部署配置管理

#### 3.3.1 Deployment Template更新流程

**配置文件结构**
```yaml
# deployment-template.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-deployment
spec:
  template:
    spec:
      containers:
      - name: main-container
        env:
        - name: CROSS_URLS
          value: "url1,url2,url3"  # 动态更新的Cross-URLs
```

**更新逻辑**
1. **数据获取**: 从数据库查询当前所有启用的Cross-URLs
2. **格式转换**: 将URL列表转换为逗号分隔的字符串格式
3. **模板更新**: 更新deployment template中的CROSS_URLS环境变量
4. **配置应用**: 使用Kubernetes API应用新的配置
5. **重启触发**: 通过rolling update方式触发Pod重启

#### 3.3.2 配置同步机制

**同步策略**
- 每次重启前强制同步最新的Cross-URLs
- 支持配置校验，确保URL格式正确
- 提供配置回滚机制，重启失败时自动回滚

**错误处理**
- 配置更新失败：保持原有配置，停止重启流程
- 重启失败：自动回滚到上一个可用配置
- 网络异常：提供重试机制，最多重试3次

#### 3.3.3 监控和验证

**配置生效验证**
- 重启完成后验证环境变量是否正确加载
- 检查服务健康状态和Cross-URLs配置可用性
- 提供配置差异检测，确保应用的配置与预期一致

**监控指标**
- 配置更新成功率
- 重启时间监控
- 配置生效时间追踪

## 4. 验收标准

### 4.1 功能验收
- [ ] DLL原有功能完全正常，无回归问题
- [ ] Cross-URL增删功能正常工作
- [ ] URL格式校验准确有效
- [ ] 重启配置按钮功能正常
- [ ] Domain Name限制正确实现
- [ ] 所有Toast提示按规范显示
- [ ] Cross-URLs正确写入deployment template
- [ ] 配置更新后服务重启成功
- [ ] 重启后环境变量正确加载
- [ ] 配置回滚机制正常工作

### 4.2 用户体验验收
- [ ] 界面响应速度≤2秒
- [ ] 错误提示清晰准确
- [ ] 操作流程直观易懂
- [ ] 视觉设计与系统整体风格一致

### 4.3 技术验收
- [ ] 代码符合团队规范
- [ ] 单元测试覆盖率≥80%
- [ ] 接口文档完整准确
- [ ] 兼容主流浏览器

## 5. 风险点和注意事项

### 5.1 技术风险
- **DLL功能回归**: 需充分测试原有功能的稳定性
- **重启机制**: Pod重启过程中的状态监控和异常处理
- **并发处理**: 多用户同时操作时的数据一致性
- **配置同步失败**: deployment template更新失败导致服务异常
- **K8s API依赖**: Kubernetes集群API不可用时的处理机制
- **配置回滚复杂性**: 多层配置回滚的一致性保证
- **环境变量限制**: 大量URLs可能超出环境变量长度限制

### 5.2 用户体验风险
- **Domain Name限制**: 需要清晰的用户引导，避免混淆
- **重启等待**: 重启过程可能较长，需要合适的用户反馈

### 5.3 缓解措施
- 完整的回归测试覆盖
- 详细的错误日志记录
- 清晰的用户操作指引
- 充分的异常情况处理
- **配置备份策略**: 每次更新前自动备份当前配置
- **分阶段部署**: 先验证配置更新，再执行重启
- **健康检查增强**: 重启后增加配置生效的健康检查
- **环境变量优化**: 考虑使用ConfigMap替代环境变量存储大量URLs
- **监控告警**: 配置更新和重启过程的全程监控告警

---

**文档版本**: V1.0  
**创建日期**: [创建日期]  
**最后更新**: [更新日期]  
**负责人**: [产品负责人]  
**开发周期**: [预估开发时间] 